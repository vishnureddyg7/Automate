import pandas as pd
import json

# Load CSV file
df = pd.read_csv(r"C:\Users\lenov\Downloads\Untitled discover search (39).csv")

# Set display options for full visibility
pd.set_option('display.max_colwidth', None)
pd.set_option('display.max_rows', None)
pd.set_option('display.max_columns', None)
pd.set_option('display.width', 1000)

# Convert @timestamp column to datetime
df['timestamp'] = pd.to_datetime(df['timestamp'], errors='coerce')

# Filter relevant events
filtered_df = df[df['event'].isin(['rqst_in_rider_order_estimate', 'parse_estimate_response_generic_partner'])]

# Sort by trace_id and timestamp
filtered_df = filtered_df.sort_values(by=['trace_id', 'timestamp'])

# Separate requests and responses
requests = filtered_df[filtered_df['event'] == 'rqst_in_rider_order_estimate'][['trace_id', 'rqst_payload']]
responses = filtered_df[filtered_df['event'] == 'parse_estimate_response_generic_partner'][['trace_id', 'resp_payload']]

# Function to safely load JSON data
def safe_json_loads(x):
    try:
        return json.loads(x) if pd.notna(x) and x.strip() else {}
    except json.JSONDecodeError:
        print(f"Error decoding JSON: {x}")
        return {}

# Convert rqst_payload and resp_payload from JSON strings to dictionaries
requests['rqst_payload'] = requests['rqst_payload'].apply(safe_json_loads)
responses['resp_payload'] = responses['resp_payload'].apply(safe_json_loads)

# Merge request and response data on trace_id
merged_df = requests.merge(responses, on='trace_id', suffixes=('_req', '_resp'))

# Filter records where serviceable is False
filtered_data = []
for _, row in merged_df.iterrows():
    if row['resp_payload'].get('serviceable') is False:
        data = {
            'customer_phone': row['rqst_payload'].get('customer', {}).get('phone', ''),
            'customer_lat': row['rqst_payload'].get('customer', {}).get('address', {}).get('latitude', ''),
            'customer_long': row['rqst_payload'].get('customer', {}).get('address', {}).get('longitude', ''),
            'customer_sublocality': row['rqst_payload'].get('customer', {}).get('address', {}).get('sub_locality', ''),           
            'store_lat': row['rqst_payload'].get('store', {}).get('latitude', ''),
            'store_long': row['rqst_payload'].get('store', {}).get('longitude', ''),
            'store_address': row['rqst_payload'].get('store', {}).get('address', ''),
            'pincode': row['rqst_payload'].get('customer', {}).get('address', {}).get('pin', ''),
            'store_name': row['rqst_payload'].get('store', {}).get('name', ''),
        }
        filtered_data.append(data)

# Convert to DataFrame
result_df = pd.DataFrame(filtered_data)

# Save to CSV
result_df.to_csv("serviceability_issues.csv", index=False)

print("Filtered data saved to 'serviceability_issues.csv'.")
